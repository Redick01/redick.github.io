# 数据库MySQL <!-- {docsify-ignore-all} -->



## MySQL主从复制过程



主从复制通过binary log（二进制日志）进行数据的同步，过程如下：

1. 从数据库连接主库请求binlog同步
2. 主库的dump线程读取binlog
3. 主库发送binlog到从库IO线程
4. 从库将读取到的日志信息存到relay log
5. 从库读取relay log
6. 从库将数据库更新时间在存储引擎中执行

## binlog三种模式



1. Statement（sql语句复制）：每一条更新的sql语句（insert，update，delete）都会记录到binlog中，进而同步到从库的relaylog中，被从库的sql线程取出，回访执行；该模式优点是binlog日志量比较少，缺点是同步的sql语句会绑定本地变量，如time，这样就会造成数据不一致
2. ROW模式：基于行的复制，不记录sql语句，只记录哪个记录更新前和更新后的数据，可以保证主从数据库数据的绝对相同，缺点是同步数据量大，比如一条sql更新1000行数据，那ROW模式必须原原本本同步1000行数据
3. Mixed模式：以上两种模式的混合，选取两者有点，对于绑定本地变量并且评估可能造成数据不一致的sql语句，使用ROW模式，其他的选择Statement模式



## 反规范化设计

【说明】
 某医药销售企业因业务发展，需要建立线上药品销售系统，为用户提供便捷的互联网药品销售服务、该系统除了常规药品展示、订单、用户交流与反馈功能外，还需要提供当前热销产品排名、评价分类管理等功能。

 通过对需求的分析，在数据管理上初步决定采用关系数据库（MySQL）和数据库缓存（Redis）的混合架构实现。

 经过规范化设计之后，该系统的部分数据库表结构如下所示：

 供应商（供应商ID，供应商名称，联系方式，供应商地址）；

 药品（药品ID，药品名称，药品型号，药品价格，供应商ID）；

 药品库存（药品ID，当前库存数量）；

 订单（订单号码，药品ID，供应商ID，药品数量，订单金额）。



【问题1】
 在系统初步运行后，发现系统数据访问性能较差。经过分析，刘工认为原来数据库规范化设计之后，关系表过于细分，造成了大量的多表关联查询，影响了性能。例如当用户查询商品信息时，需要同时显示该药品的信息、供应商的信息、当前库存等信息。

 为此，刘工认为可以采用反规范化设计来改造药品关系的结构，以提高查询性能。修改后的药品关系结构为：

 药品（药品ID，药品名称，药品型号，药品价格，供应商ID，供应商名称，当前库存数量）；

 请用 200 字以内的文字说明常见的反规范化设计方法，并说明用户查询商品信息应该采用哪种反规范化设计方法。



答案：增加冗余列

常见的反规范化设计：

1. 增加冗余列：在多个表中保留相同的列，通过数据冗余手段避免多个表关联查询
2. 水平分割表：对表进行按记录分割，把数据放到多个独立的表中，主要用于数据量很大，表中数据相对独立，或需要存储在不同介质中时使用
3. 垂直分割表：对表进行分割，将主键和部分列放到一个表，将主键和其他列放到另一个表，降低查询时候的IO
4. 重新组表：如果数据来源是多个表，可以考虑将读取的数据组装成一个新的表，避免关联查询，提高性能
5. 增加新的派生列：增加新的列存储由其他列计算产生的数据，避免检索的时候进行运算



【问题2】

 王工认为，反规范化设计可提高查询的性能，但必然会带来数据的不一致性问题。请用 200 字以内的文字说明在反规范化设计中，解决数据不一致性问题的三种常见方法，并说明该系统应该采用哪种方法。

触发器

常见的反规范化数据一致性问题解决办法：

1. 批处理（最终一致性）：通过定期运行批处理程序或存储过程对数据库进行批量修改，适用于实时性要求不高场景
2. 应用逻辑：在同一个事务中对所有涉及的表进行增，删，改操作，同一逻辑必须在所有应用中进行维护。缺点是容易遗漏，不易于维护
3. 触发器：对数据的任何修改立即触发对数据库某些列的相应修改，实时性高

【问题3】
 该系统采用了 Redis 来实现某些特定功能（如当前热销药品排名等），同时将药物关系数据放到内存以提高商品查询的性能，但必然会造成 Redis 和 MySQL 的数据实时同步问题。

（1）Redis 的数据类型包括 String、Hash、List、Set 和 ZSet 等，请说明实现当前热销药品排名的功能应该选择哪种数据类型。

（2）请用 200 字以内的文字解释说明解决 Redis 和 MySQL 数据实时同步问题的常见方案。

答案：
（1）ZSet：有序的集合，每个元素有一个分数，如首页推荐10个最热门的的帖子

String：基本类型，用于缓存和基数，如播放量等

Hash：代替String，节省空间，描述用户信息比较方便

Set：无需集合，用于去重

List：双向链表结构，可以模拟队列，栈等形式，可用于回复评论，点赞等

（2）MySQL事务，通过事务保证一致性，事务提交成功后更新缓存；通过中间件完成数据库和缓存同步；在缓存里引用数据变更控制位当数据变更后，同步的修改控制位，从缓存查询时检查控制位，如果控制位变化从数据库中查询然后更新在更新缓存，控制位无变化就直接用缓存