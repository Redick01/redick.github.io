# 面向服务的架构设计 <!-- {docsify-ignore-all} -->

### 服务化概念

​    对于跨构件的功能调用，采用（网络）接口的形式暴露出来，进一步将接口的定义和实现解耦，则催生了服务化和面向服务（Service Oriented，SO）的开发方法。



### 面向服务的架构设计

​    面向服务的架构（SOA）是一种应用框架，它着眼于日常业务应用，并将业务划分为不同的单独业务功能和流程，即所谓的服务，SOA使用户可以构建，部署和整合这些服务，且无需依赖应用程序及其运行平台，从而提高了业务的灵活性，有助于实现更多的资源重用、更轻松的管理，更快的开发和部署。

​    SOA是一个组件模型，它将应用程序的不同功能单元（服务）通过这些服务之间定义的良好的接口和契约联系起来。接口是采用中立的方式进行定义的，它独立于实现服务的硬件平台、操作系统和编程语言。这使得构建在各种各样系统中的服务可以以一种统一和通用的方式进行交互。

​    BPEL，面向Web Service的业务流程执行语言，使用BPEL，用户可以通过组合，编排和协调Web服务自上而下的实现面向服务的体系结构。BPEL提供了一种相对简单易懂的方法，可以将多个Web服务组合到一个新的符合服务（称为业务流程）中。



### SOA主要协议与规范

- 什么是Web Services（Web 服务）：

​     如果一个服务（service）暴露的网络接口是http接口，则称该服务为web service。

- Web Services的特征：

1. Web Services 是应用程序组件。

2. Web Services 使用开放协议（以HTTP承载的SOAP）进行通信。

3. Web Services 是独立的（self-contained）并可自我描述。

4. Web Services 可通过使用UDDI来发现。

5. Web Services 可被其他应用程序使用或访问。

​    XML 是 Web Services 的基础（其实目前更多使用的是JSON）。业务方若想使用某个WebService的服务，什么都不用耦合，只需要记住UDDI在哪儿，用的时候现场查询、现场使用即可。



##### WSDL（Web Service Description Language），web服务描述语言包，是一个用来描述Web服务和说明如何与Web服务通信的XML语言。它是Web服务的接口定义语言，可描述Web服务的三个重要属性

1. Web服务提供做些什么，即提供了什么方法；
2. 如何访问Web服务，即Web服务的访问方式和访问的数据格式和协议；
3. Web服务在哪，即Web服务的URL。

​    WSDL文档以端口集合的形式来描述 Web 服务，WSDL服务描述包含对一组操作和消息的一个抽象定义，绑定到这些操作和消息的一个具体协议，和这个绑定的一个网络端点规范。WSDL文档被分为两种类型：服务接口(Service Interface)和服务实现 (ServiceImplementations)。



##### SOAP 是在分散或分布式的环境中交换信息的简单的协议，是一个基于 XML 的协议。它包括4个部分:

- SOAP 封装(Envelop)，定义了一个描述消息中的内容是什么，是谁发送的，谁应当接收并处理它以及如何处理它们

的框架;

- SOAP 编码规则(Encoding Rules)，用于表示应用程序需要使用的数据类型的实例;

- SOAP RPC 表示(RPC Representation)是远程过程调用和应答的协定;

- SOAP绑定(Binding)是使用底层协议交换信息。



##### SOAP 的两个主要设计目标是简单性和可扩展性。

1. 在SOA架构中各组件之间传递消息，依靠HTTP协议来实现，双方交互数据存放在HTTP body中。通过规定统一的SOA协议来规范服务的远程调用。

2. SOAP也属于应用层协议，但它依赖HTTP协议。类似的还有Websocket协议等



### SOA-面向服务架构的设计模式

##### 服务注册表模式

1. 服务注册
2. 服务位置：就是服务发现
3. 服务绑定：就是服务调用

##### 企业服务总线模式（ESB）

ESB的核心功能如下。

(1)提供位置透明性的消息路由和寻址服务。

(2)提供服务注册和命名的管理功能。

(3)支持多种消息传递范型(如请求/响应、发布/订阅等)

(4)支持多种可以广泛使用的传输协议。

(5)支持多种数据格式及其相互转换。

(6)提供日志和监控功能。

##### 微服务模式

​    微服务架构将一个大型的单个应用或服务拆分成多个微服务，可扩展单个组件而不是整个应用程序堆栈，从而满足服务等级协议。

​    微服务架构围绕业务领域将服务进行拆分，每个服务可以独立进行开发、管理和迭代，彼此之间使用统一接口进行交流，实现了在分散组件中的部署、管理与服务功能，使产品交付变得更加简单，从而达到有效拆分应用，实现敏捷开发与部署的目的。

1. 复杂应用解耦：微服务架构将单一模块应用分解为多个微服务，同时保持总体功能不变，应用按照业务逻辑被分解为多个可管理的分支或服务，避免了复杂度的不断积累，每个服务专注于单一功能，通过良好的接口清晰表达服务边界，由于功能单一、复杂度提，小规模的开发团队完全能够掌握，易于保持较高开发效率，易于维护。
2. 独立：微服务在系统软件生命周期中是独立开发、测试及部署的。当微服务变更时，不需要整个系统都编译，部署，从测试角度来说，微服务具备测试的独立机制，服务更新不需要大范围的回归测试，不用担心测试破坏系统其他功能。因此，微服务组成的系统应用具备一系列可并行的发布流程，使得开发、测试、部署更高效，同时降低因系统变更带来的生产环境风险。
3. 灵活技术选型：微服务架构下系统应用技术选型是去中心化的，每个开发团队可根据自身业务需求发展状况选择合适的体系架构和技术，从而更方便地根据实际业务情况获得系统应用最佳解决方案，并且每个微服务功能单一、结构简单，在架构摘星或技术栈升级时面临较低风险，因此系统应用不会长期限制在某个体系架构或技术栈上。
4. 容错：在传统单体应用架构下，当某一模块发生故障时，该故障极有可能在整个应用内扩散，造成全局应用系统瘫痪。然后在微服务架构下，由于各个微服务相互独立，`故障会被隔离在单个服务中`，并且系统其他服务可通过重试、平稳退货等机制实现应用层容错，从而提高系统应用容错性。微服务架构良好的容错机制可避免出现单个服务故障导致整个系统瘫痪的情况。
5. 松耦合易扩展：传统单体应用家沟通过将整个应用完整地复制到不同节点，从而实现横向扩展。但当系统应用的不同组件在扩展需求上存在差异时，会导致系统应用的水平扩展成本很高。微服务架构中每个微服务都是松耦合的，可以根据实际需求实现独立扩展，体现微服务架构的灵活性。



### 微服务设计模式

##### 聚合器为服务模式

1. 将检索到的数据信息进行处理并直接展示；
2. 对获取到的数据信息增加业务逻辑处理后，再进一步发布成一个新的微服务，作为一个更高层次的组合微服务，相当于从服务消费者转换成服务提供者。

聚合器微服务与普通微服务相同，也有自己的缓存和数据库。

##### 代理微服务模式

​    作为聚合器模式的变种，客户端不需要聚合数据，只会根据实际业务需求差别选择调用具有不同功能的微服务，代理微服务仅进行委派请求和数据转换工作。同样地代理微服务也有独立的缓存和数据库，代理模式一个请求只访问一个微服务。

##### 分支微服务器模式

​    聚合器微服务模式的一种扩展，在分支微服务器模式下，客户端或服务允许同时调用亮哥不同的微服务链。连个微服务调用链相互独立，互不影响。

##### 链式微服务模式

   客户端或服务在收到请求后，会返回一个经过合并处理的响应，该模式即为链式微服务设计模式。

##### 数据共享微服务模式

​    运用微服务架构重构现有单体架构应用时，SQL 数据库反规范化可能会导致数据重复与不一致现象。按照微服务的自治设计原则，在单体架构应用到微服务架构的过渡阶段，可以使用数据共享微服务设计模式。在该模式下，当服务之间存在强耦合关系时，可能存在多个微服务共享缓存与数据库存储的现象。

##### 异步消息传递微服务模式

​    目前流行开发RESTful 风格的API，REST 使用HTTP 协议控制资源，并通过URL加以实现。REST 提供了一系列架构系统参数作为整体使用，强调组件的独立部署、组件交互的扩展性，以及接口的通用性，并且尽量减少产生交互延迟的中间件数量。

​    但是 REST 设计模式是同步的，容易造成阻塞，从而耗费大量时间。消息队列将消息写入一个消息队列中，实现业务逻辑以异步方式运行，从而加快系统响应速度。因此，对于一些不必要以同步方式运行的业务逻辑，可以使用消息队列代替 REST 实现请求、响应，加快服务调用的响应速度。但该模式可能会降低系统可用性，并增加系统复杂性，因而在使用过程中，要做好消息队列的选型。常用消息队列有 ActiveMQ、RabbitMQ、RocketMQ、Kafka 等。

### 微服务面临的问题和挑战

1. 分布式特点带来的复杂性，开发过程中，需要基于RPC或消息实现微服务之间的调用与通信，使服务发现与服务调用链追踪变得困难。
2. 微服务架构的分区数据库体系，不同的服务拥有不同的数据库，受限于CAP原理约束以及NoSQL数据库的高扩展性，使人们不得不放弃传统数据库的强一致性，转而追求最终一致性，因此对开发人员的要求更高。
3. 给系统测试带来了很大的挑战，微服务架构可能涉及多个服务，传统的单体Web应用只需测试单一API即可，然而对于微服务架构测试，需要启动其依赖的所有服务，复杂性不可低估。
4. 在大规模的应用部署中，在监控、管理、分支及扩容等方面，微服务也存在着巨大挑战。

​    因此，对于微服务架构的取舍，要考虑企业开发团队规模、业务需求变化以及系统用户群体规模等诸多因素。使用微服务架构主要是为了降低应用程序开发、维护等方面的复杂性，如果系统程序架构已无法再扩展，或数据库增长速度过快，并且整个团队(包括产品、设计、研发、测试、运维)都具备微服务思维，采用微服务架构的收益会大于成本。但如果系统现有程序架构还能很好地工作，不需要有太大改动，采用微服务架构则不会有太多收益。综上所述，尽管微服务架构有很多优势，但在使用微服务架构之前要结合系统自身特点，综合评估后再决定是否采用微服务架构。



### SOA设计原则

1. 无状态
2. 单一实例，避免功能冗余
3. 明确定义的接口：服务定义必须长时间稳定，一旦公布，不能随意更改；服务的定义应接可能明确，减少使用者的不适当使用；不要让使用者看到微服务内部的私有数据。
4. 自包含和模块化：服务封装了那些在业务上稳定、重复出现的活动和组件，实现服务的功能实是完全独立的，独立进行部署、版本控制、自我管理和恢复。
5. 粗粒度：服务数量不应太大，依靠消息交互而不是远程调用，通常消息量比较大，但是服务之间的交互频度较低。
6. 服务之间松耦合性：服务使用者看到的是服务的接口，其位置、实现技术和当前状态对使用者是不可见的，服务私有数据对服务使用者是不可见的。
7. 重用能力：服务应该是可重用的。
8. 互操作性、兼容和策略声明：为了确保服务规约的全面和明确，策略成为一个越来越重要的方面。这可以是技术相关的内容，例如一个服务对安全性方面的要求；也可以是跟业务有关的语义方面的内容，例如需要满足的费用或者服务级别方面的要求，这些策略对于服务在交互时是非常重要的。在设计时，应该利用策略声明确保服务期望和语义兼容性方面的完整和明确。