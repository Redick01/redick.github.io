# 论文一 <!-- {docsify-ignore-all} -->



## 论Mesh化架构应用



### 摘要

​    2021年下旬，我作为系统架构师参与某一线城市轨道交通（地铁）互联网票务平台架构升级项目，期间负责架构评估，技术选型，技术方案制定，技术规范制定，指导开发等工作。该系统是某一线城市轨道交通互联网票务平台系统，自从系统2017年上线以来，随着业务不断拓宽，用户量逐渐增大，我司现有系统面临一系列问题，如分布式组件升级困难、不具备弹性扩缩容能力、不具备灰度发布能力、流量控制粒度粗、运维操作麻烦、硬件成本高等，因此公司认为现有系统无法满足更多的业务，所以公司提出本项目。

​    本篇文章以此项目为例，论述了Mesh化架构在实际项目中的应用落地；首先我介绍Mesh化架构思想和所要解决的问题以及面临的挑战；然后我分析本项目现有系统的现状，阐述导致现有系统问题的原因；再论述Mesh化架构如何解决现有系统问题；最后制定架构平滑升级的方案，评审，实施；上线后经过两年多的稳定运行，成功达成了公司的目标，获得了公司内领导一致好评。

### 正文

​    随着移动互联网时代的到来，移动支付、智慧交通、智慧城市等概念火了起来，为了丰富市民的出行方式，各个城市也都大力发展移动出行，2017年，我司所承接的某一线城市轨道交通互联网票务平台成功上线，该平台包含该城市官方指定的轨道交通APP、APP后台和管理后台等系统，该平台的核心功能有线上购票、线下取票、扫码购票、扫码乘车、地图查询、地铁线路规划、预约进站、延误公告、线网图、后付费NFC乘车等，该平台日交易量在1000万左右，日活跃用户150万，累计用户达到3500万。APP经过三年的运营后又拓展了其他城市的轨道交通乘车业务、多元化的支付渠道支持（支付宝、微信、银行卡、云闪付、京东等等）、建立营销平台、建立卡券积分等等。

​    2021年下旬，随着业务体量的不断增加，该平台的后台系统遇到了一系列的问题，包括分布式组件升级困难、不具备弹性扩缩容能力、不具备灰度发布能力、流量控制粒度粗、运维操作麻烦、硬件成本高，因此公司提出采用Mesh化架构升级的方式解决平台现有问题。我作为系统架构师参与了该项目，我在该项目中主要负责的工作由Mesh化架构评估，Mesh技术选型，技术方案制定，编码规范制定，指导开发等工作，在公司技术委员会决定采用Mesh化架构解决该平台问题后，我经过技术调研与技术选型，选择时下比较火的Istio+Envoy作为Mesh架构的组，应用软件间选择使用轻量级HTTP协议进行交互。

​    Mesh化架构，是把具有分布式语义（RPC、限流、降级、服务发现、隔舱、被压、灰度等）的中间件框架从业务系统中剥离出去，使得业务系统只关注业务逻辑的实现，不需要关心任何的分布式语义；Mesh化架构可以做到语言无关性，业务应用可以由任何语言编写，只需要和Mesh框架通信即可；Mesh化架构下，Mesh组件对应用是透明的，Mesh组件可以单独升级，升级对业务没有任何进程。

​    Mesh化架构目前也面临一些挑战，一个是Mesh组件以代理的模式计算并转发流量，网络上增加了一跳，一定程度上会降低性能，并且增加系统资源的开销；另一个是Mesh组件接管了网络流量，因此服务整体的稳定性依赖于Mesh组件，同时额外引入了大量的Mesh服务实例运维和管理也是一个挑战。

​    Mesh化架构升级之前，该项目的系统架构采用微服务架构，基础设施层使用虚拟机，微服务治理组件使用DubboX，熔断组件使用Hystrix，服务注册中心使用Zookeeper，限流组件使用的是Bucket4j；在平台发展初中期该架构运行比较平稳，随着业务体量的增加，基于该架构构建的微服务架构就产生了许多痛点，第一，基础设施为虚拟机，很难做到弹性的扩缩容，这一点在轨道交通领域其实挺重要的，因为对于轨道交通业务来说存在业务高低峰期，即早晚高峰，如果系统支持弹性扩缩容就可以在早晚高峰期扩容更多的节点以应对业务量，当过了高峰期就可以缩减节点；第二，使用DubboX、Zookeeper、Hystrix、Bucket4j等组件作为微服务治理组件是与业务应用程序集成在一起，遇到微服务治理组件升级对业务系统产生影响；第三，应用发布形式单一，目前架构只能做到滚动发布，无法通过细化的流量切割做到灰度发布；第四，微服务升级过程中运维操作繁琐，在微服务升级过程中，运维需要需要调整负载均衡策略进行滚动发布，即先停掉一个节点的流量进行升级，升级后逐步的放流量，开发人员观察日志，如无问题依次进行发布，运维操作十分繁琐；第五，硬件成本较高，当前架构采用的是虚拟机作为基础设施，需要的硬件比较多，所以成本比较高。

   通过Mesh化架构升级，Mesh化架构所具有的特点能够很好的解决以上的问题，第一，Mesh化架构和容器技术以及容器编排Kubernetes是紧密融合的，通过Mesh架构、容器技术和Kubernetes的配合轻松的实现弹性扩缩容；第二，Mesh化架构使用Envoy作为网络代理组件，Envoy作为单独的进程中注入到业务应用的容器中，接管网络流量，也具备熔断、限流、隔舱等分布式语义，服务发现由Kubernetes组件提供支持，所以Envoy组件升级完全不影响业务模块；第三，Mesh化架构由Envoy作为流量代理组件，Istio作为控制平台，Envoy对流量的治理粒度更细，配合Istio下发的流量规则，可以相当容易的实现灰度发布；第四，Mesh化架构升级后，通过容器编排技平台Kubernetes，运维人员在应用升级发布时的工作量大大降低，应用发布的流程被编写成规则，通过Kubernetes自动编排调度应用就可以升级发布；第五，Mesh化架构升级后，由于对容器技术的使用，应用弹性伸缩的支持，可以使得应用节点按需扩缩容，节省了非常客观的硬件成本。

​    分析完该平台现阶段架构的问题以及Mesh化架构改造如何解决现有问题之后，我着手制定平台Mesh化架构改造的技术方案以及平台平滑升级Mesh化架构的方案。

​    Mesh化改造技术方案主要是微服务的改造方案，改造的点如下：

1. 微服务去掉微服务治理组件，DubboX、Zookeeper、Hystrix、Bucket4j等；
2. 微服务统一使用轻量级的HTTP协议发布接口；
3. 微服务的服务发现使用Kubernetes Service进行服务发现；
4. 微服务间通信使用轻量级HTTP客户端通过Kubernetes Service名加接口path进行RPC调用；

​    Mesh化改造平滑升级方案，该平台属于2C的平台，2C的系统无法容忍长时间的无法为用户提供服务，所以我司的的可用性标准是允许服务总断不超过五分钟，并且在大的架构升级迭代的过程中，需要在轨道交通停止运营之后进行升级，升级完成后由测试人员下到车站进行业务的回归测试，回归测试完成后才可以面向用户发布。但是此次的Mesh化架构升级的复杂程度是前所未有的，所以以往的升级方案都是不满足要求，所以针对此次升级我单独制定了一套升级方案，大致方案的步骤如下：

1. 运维重新搭建一套环境，搭建Kubernetes集群，安装容器组件，该环境与原有的生产环境隔离开来；
2. 运维搭建容器镜像仓库；
3. 微服务代码打包流水线增加制作容器镜像规则；
4. CI工具制作微服务镜像并发布到镜像仓库；
5. 运维准备微服务发布的规则；
6. 运维人员通过Kubernetes进行微服务的发布；
7. 由于新环境与原生产环境隔离，所以轨道交通APP及其票务平台的流量还是打到原生产环境；
8. 发布灰度版本APP，灰度版本的APP流量切到新环境当中；
9. 进行批量的灰度测试以及全链路压测；
10. 经过一段时间的灰度测试后系统没有问题后逐步的将主APP的流量切换到Mesh化架构的环境中，直至所有流量完全切换；
11. 全部流量切换完毕后原架构系统没有任何流量后将原架构资源释放，致此完成此次升级。

​    上述技术方案和升级方案经过公司技术委员会、市轨道交通指挥中心领导的评审无问题后开始实施，经过半年的改造实施，项目成功上线，上线后经过一个月的灰度测试和全链路压测后将逐步的将生产APP流量进行切换又经过3个月流量全部切换完成，该项目升级完成已经平稳运行一年多，公司业务扩展再没遇到过瓶颈，同时又为公司解约了成本，此次升级获得了公司领导、市轨道交通指挥中心领导的一致好评。

​    在此项目设计、实施、升级的过程中让我深刻体会到了架构师不仅要在技术深度、广度上要有一定能力，而且在业务上，系统的审视角度上也要有大局观，要根据业务特性，系统现有情况下选择最合适的架构去解决问题，在此次项目的参与中让我收获巨大，更加坚定了我在架构师道路上的深耕，要不断学习，不断进步，通过技术，为企业，为客户创造更大的价值。



